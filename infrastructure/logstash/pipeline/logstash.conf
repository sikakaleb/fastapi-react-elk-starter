# Logstash Pipeline Configuration
# This pipeline receives JSON logs from FastAPI backend via TCP
# and forwards them to Elasticsearch

input {
  # TCP input on port 5000 to receive JSON logs from Python applications
  tcp {
    port => 5000
    codec => json_lines
    type => "fastapi-logs"
  }
}

filter {
  # Parse timestamp if present
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601" ]
    }
  } else {
    # Use current time if no timestamp
    ruby {
      code => "event.set('@timestamp', Time.now.utc.iso8601)"
    }
  }

  # Add host information
  mutate {
    add_field => { "logstash_host" => "%{host}" }
  }

  # Parse request information if present
  if [request_id] {
    mutate {
      add_field => { "[@metadata][request_id]" => "%{request_id}" }
    }
  }

  # Parse HTTP method and path
  if [method] and [path] {
    mutate {
      add_field => { "http_method" => "%{method}" }
      add_field => { "http_path" => "%{path}" }
    }
  }

  # Parse status code
  if [status_code] {
    mutate {
      add_field => { "http_status" => "%{status_code}" }
    }
  }

  # Parse response time
  if [response_time_ms] {
    mutate {
      convert => { "response_time_ms" => "float" }
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "logstash-%{+YYYY.MM.dd}"
  }

  # Optional: Also output to stdout for debugging (comment out in production)
  # stdout {
  #   codec => rubydebug
  # }
}
